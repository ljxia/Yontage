<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Yo!</title>
    <link rel="stylesheet" href="/stylesheets/style.css" type="text/css" media="screen" title="master" charset="utf-8" />
  </head>
  <body>
    <div id="tvs"></div>
    <div id="controls">
      <span class="query-box">
        <input type="search" id="video-search" placeholder="Search Video Here..." />
      </span>
    </div>
    
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.3/jquery.min.js"></script>
    <script src="/scripts/jquery.masonry.min.js" type="text/javascript" charset="utf-8"></script>
    
    <script src="/scripts/app.js" type="text/javascript" charset="utf-8"></script>
    <script src="/scripts/tv.js" type="text/javascript" charset="utf-8"></script>
    
    
    <script type="text/javascript" src="/_ah/channel/jsapi"></script>
    <script>
      var players = [];
      var videos = [];
      
      function addVideo(video_id){
        return $('<div></div>').prependTo('#tvs').TVSet().init(video_id);
      }
      
      function playAll(){
        for(i in players){$(players[i]).TVSet().playVideo();}
      }
      function stopAll(){
        for(i in players){$(players[i]).TVSet().stopVideo();}
      }
      
      function debug(){
        $.get('/q/' + token + '/' + "nyan+cat",function(data){
          // console.log("after ajax");
          // console.log(data);
        });
      }

      function findVideos(query){
        var url = "https://gdata.youtube.com/feeds/api/videos";
        $.get(url,{
          'q':query,
          'orderby':'published',
          'max-results':12,
          'alt':'json',
          'format':5,
          'paid-content':false,
          'v':2
        },function(data){
          if (data.feed.entry)
            for (var i=0; i < data.feed.entry.length; i++) {
              var o = data.feed.entry[i];
              var videoid = o["media$group"]["yt$videoid"]["$t"];
              console.log(videoid);
              players.push(addVideo(videoid)[0]);
            };
            
            $('#tvs').masonry({
              itemSelector: '.tv',
              isAnimated: true
            });
        })
      }
      
      function onLayout(){
        $('span.query-box').css({
          'position':'absolute',
          'left': (window.innerWidth - $('span.query-box').width())/2 + "px",
          'top': (window.innerHeight - $('span.query-box').height())/2 + "px"
        });
      }

      function onYouTubePlayerAPIReady() {
        //['CGbfKZrUsK0', 'pDCLjNsWpHY', '74HlsUaYOpw','bHQqvYy5KYo', 'uAusmM0fhkc']; ////,'q7n9GCDh8A8'
        
        //for (var j = 0;j < 2;j++)
        for (i in videos)
        {
          var p = addVideo(videos[i]);
          players.push(p[0]);       
        }
        
      }

      var token = '{{token}}';
      var channel, socket;
      var onChannelOpened, onChannelMessage, onChannelError, onChannelClose;
      
      onChannelOpened = function(){
        console.log("Channel opened");
        console.log(channel);
      }
      
      onChannelMessage = function(message){
        console.log("Channel Message Received");
        console.log(JSON.parse(message.data));
      }
      
      $(document).ready(function(){
        $("body").mousemove(function(event) {
          for(i in players){$(players[i]).TVSet().handleMouseMove(event.pageX, event.pageY);}
        });
        
        
        $(window).bind('resize',onLayout);
        
        $('#video-search').bind('keypress',function(event){
          if ( event.which == 13 ) {
            $(this).hide();
            findVideos($('#video-search').val());
           }
        });
        
        onLayout();
        
        
        channel = new goog.appengine.Channel('{{channel_token}}');
        socket = channel.open();
        socket.onopen = onChannelOpened;
        socket.onmessage = onChannelMessage;
        socket.onerror = onChannelError;
        socket.onclose = onChannelClose;
        
      });
    </script>
  </body>
</html>