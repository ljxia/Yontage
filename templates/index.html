<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Yo!</title>
    <link rel="stylesheet" href="/stylesheets/style.css" type="text/css" media="screen" title="master" charset="utf-8" />
  </head>
  <body>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.3/jquery.min.js"></script>
    <script src="/scripts/app.js" type="text/javascript" charset="utf-8"></script>
    <script src="/scripts/tv.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="/_ah/channel/jsapi"></script>
    <script>
      var players = [];
      
      function addVideo(video_id){
        return $('<div></div>').prependTo('body').TVSet().init(video_id);
      }
      
      function playAll(){
        for(i in players){$(players[i]).TVSet().playVideo();}
      }
      function stopAll(){
        for(i in players){$(players[i]).TVSet().stopVideo();}
      }
      
      function debug(){
        // for(i in players){
        //   console.log(players[i].offsetLeft + "," + players[i].offsetTop, players[i].clientWidth,players[i].clientHeight);
        // }
        
        $.get('/q/' + token + '/' + "nyan+cat",function(data){
          // console.log("after ajax");
          // console.log(data);
        });
      }

      function findVideos(query){
        var url = "https://gdata.youtube.com/feeds/api/videos";
        $.get(url,{
          'q':query,
          'orderby':'published',
          'alt':'json',
          'format':5,
          'paid-content':false,
          'v':2
        },function(data){
          console.log(data);
        })
      }

      function onYouTubePlayerAPIReady() {
        videos = ['CGbfKZrUsK0', 'pDCLjNsWpHY', '74HlsUaYOpw','bHQqvYy5KYo', 'uAusmM0fhkc']; ////,'q7n9GCDh8A8'
        
        //for (var j = 0;j < 2;j++)
        for (i in videos)
        {
          var p = addVideo(videos[i]);
          players.push(p[0]);       
        }
        
      }

      var token = '{{token}}';
      var channel, socket;
      var onChannelOpened, onChannelMessage, onChannelError, onChannelClose;
      
      onChannelOpened = function(){
        console.log("Channel opened");
        console.log(channel);
      }
      
      onChannelMessage = function(message){
        console.log("Channel Message Received");
        console.log(JSON.parse(message.data));
      }
      
      $(document).ready(function(){
        $("body").mousemove(function(event) {
          for(i in players){$(players[i]).TVSet().handleMouseMove(event.pageX, event.pageY);}
        });
        
        
        channel = new goog.appengine.Channel('{{channel_token}}');
        socket = channel.open();
        socket.onopen = onChannelOpened;
        socket.onmessage = onChannelMessage;
        socket.onerror = onChannelError;
        socket.onclose = onChannelClose;
        
      });
    </script>
  </body>
</html>